name: Daily Stock Signal Check

on:
  # ë§¤ì¼ ìë™ ì‹¤í–‰ (ë‰´ìš• ì‹œê°„ ì˜¤í›„ 4:30 = UTC 21:30)
  schedule:
    - cron: '30 21 * * 1-5'  # ì›”-ê¸ˆ, UTC 21:30 (ë‰´ìš• 4:30 PM)
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥
  workflow_dispatch:

jobs:
  check-signals:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run signal check
      id: signal_check
      run: |
        python -c "
import sys
sys.path.insert(0, '.')
from src.data.cache import DataCache
from src.data.fetcher import DataFetcher
from src.data.validator import DataValidator
from src.features.technical import TechnicalIndicators
from src.discovery.validated_patterns import VALIDATED_PATTERNS
from src.utils.helpers import load_config
from datetime import datetime
import json

config = load_config()
ticker = 'QQQ'

# ë°ì´í„° ë¡œë“œ
cache = DataCache(cache_dir='data/cache', max_age_hours=24)
df = cache.get(ticker)
if df is None:
    fetcher = DataFetcher([ticker])
    data = fetcher.fetch('10y')
    df = data[ticker]
    df, _ = DataValidator.validate(df, ticker)
    cache.set(ticker, df)

indicators = TechnicalIndicators(config.get('indicators', {}))
df = indicators.calculate_all(df)

# ì˜¤ëŠ˜ ì •ë³´
today = df.iloc[-1]
today_date = df.index[-1].strftime('%Y-%m-%d')
close = today['Close']
open_p = today['Open']
high = today['High']
low = today['Low']
rsi = today['rsi']

# ë§¤ìˆ˜ ì‹œê·¸ë„ ì²´í¬ (RSI < 35)
rsi_pattern = None
for p in VALIDATED_PATTERNS:
    if p.name == 'RSI_Oversold_35':
        rsi_pattern = p
        break

buy_signal = rsi_pattern.check(today) if rsi_pattern else False

# ë§¤ë„ ì‹œê·¸ë„ ì²´í¬ (RSI > 70)
sell_signal = rsi > 70

# ê²°ê³¼ ì¶œë ¥
print(f'DATE={today_date}')
print(f'CLOSE={close:.2f}')
print(f'OPEN={open_p:.2f}')
print(f'HIGH={high:.2f}')
print(f'LOW={low:.2f}')
print(f'RSI={rsi:.1f}')
print(f'BUY_SIGNAL={buy_signal}')
print(f'SELL_SIGNAL={sell_signal}')

if buy_signal:
    print('SIGNAL_TYPE=BUY')
elif sell_signal:
    print('SIGNAL_TYPE=SELL')
else:
    print('SIGNAL_TYPE=NONE')
" > result.txt 2>&1 || true
        
        cat result.txt
        
        # ê²°ê³¼ íŒŒì‹±
        DATE=$(grep "DATE=" result.txt | cut -d= -f2 || echo "N/A")
        CLOSE=$(grep "CLOSE=" result.txt | cut -d= -f2 || echo "N/A")
        OPEN=$(grep "OPEN=" result.txt | cut -d= -f2 || echo "N/A")
        HIGH=$(grep "HIGH=" result.txt | cut -d= -f2 || echo "N/A")
        LOW=$(grep "LOW=" result.txt | cut -d= -f2 || echo "N/A")
        RSI=$(grep "RSI=" result.txt | cut -d= -f2 || echo "N/A")
        SIGNAL_TYPE=$(grep "SIGNAL_TYPE=" result.txt | cut -d= -f2 || echo "NONE")
        
        echo "date=$DATE" >> $GITHUB_OUTPUT
        echo "close=$CLOSE" >> $GITHUB_OUTPUT
        echo "open=$OPEN" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
        echo "low=$LOW" >> $GITHUB_OUTPUT
        echo "rsi=$RSI" >> $GITHUB_OUTPUT
        echo "signal_type=$SIGNAL_TYPE" >> $GITHUB_OUTPUT
        
        if [ "$SIGNAL_TYPE" = "BUY" ]; then
          echo "ğŸŸ¢ ë§¤ìˆ˜ ì‹œê·¸ë„!"
        elif [ "$SIGNAL_TYPE" = "SELL" ]; then
          echo "ğŸ”´ ë§¤ë„ ì‹œê·¸ë„!"
        else
          echo "ğŸ“­ ì‹œê·¸ë„ ì—†ìŒ"
        fi
    
    - name: Send email notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "${{ steps.signal_check.outputs.signal_type == 'BUY' && 'ğŸŸ¢ ë§¤ìˆ˜ ì‹œê·¸ë„!' || steps.signal_check.outputs.signal_type == 'SELL' && 'ğŸ”´ ë§¤ë„ ì‹œê·¸ë„!' || 'ğŸ“­ ì‹œê·¸ë„ ì—†ìŒ' }} QQQ - Auto-Stock"
        to: ${{ secrets.EMAIL_TO }}
        from: Auto-Stock Bot
        body: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“Š Auto-Stock ì¼ì¼ ë¦¬í¬íŠ¸
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“… ë‚ ì§œ: ${{ steps.signal_check.outputs.date }}
          
          ğŸ’° ê°€ê²© ì •ë³´
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ì‹œê°€: ${{ steps.signal_check.outputs.open }}
          ê³ ê°€: ${{ steps.signal_check.outputs.high }}
          ì €ê°€: ${{ steps.signal_check.outputs.low }}
          ì¢…ê°€: ${{ steps.signal_check.outputs.close }}
          
          ğŸ“ˆ ê¸°ìˆ  ì§€í‘œ
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          RSI: ${{ steps.signal_check.outputs.rsi }}
          
          ë§¤ìˆ˜ ê¸°ì¤€: RSI < 35 (ê³¼ë§¤ë„)
          ë§¤ë„ ê¸°ì¤€: RSI > 70 (ê³¼ë§¤ìˆ˜)
          
          ğŸš¨ ì‹œê·¸ë„
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ${{ steps.signal_check.outputs.signal_type == 'BUY' && 'ğŸŸ¢ ë§¤ìˆ˜ ì‹œê·¸ë„ ë°œìƒ! (RSI < 35)' || steps.signal_check.outputs.signal_type == 'SELL' && 'ğŸ”´ ë§¤ë„ ì‹œê·¸ë„ ë°œìƒ! (RSI > 70)' || 'ğŸ“­ ì˜¤ëŠ˜ì€ ì‹œê·¸ë„ ì—†ìŒ' }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ìì„¸í•œ ë¶„ì„ì€ ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”
          ${{ github.server_url }}/${{ github.repository }}

